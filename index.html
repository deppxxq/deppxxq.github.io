<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>F1 Style Top 3</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Teko:wght@500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --f1-red:#e10600;
    --bg0:#050505;
    --bg2:#2a0000;
    --card: rgba(10,10,10,.72);
    --text: rgba(255,255,255,.94);
    --muted: rgba(255,255,255,.72);

    --gold1:#b8860b; --gold2:#ffd700;
    --silver1:#7d7d7d; --silver2:#c0c0c0;
    --bronze1:#8b4513; --bronze2:#cd7f32;
  }

  *{ box-sizing:border-box; }

  html, body{
    margin:0; padding:0;
    width:100%; height:100%;
    color: var(--text);
    overflow:hidden;
    background:
      radial-gradient(1200px 800px at 80% 10%, rgba(225,6,0,.25), transparent 55%),
      radial-gradient(900px 700px at 20% 90%, rgba(225,6,0,.18), transparent 60%),
      linear-gradient(135deg, var(--bg0), var(--bg2));
    font-family: Rajdhani, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  body::before{
    content:"";
    position:fixed; inset:0;
    background:
      repeating-linear-gradient(45deg, rgba(255,255,255,.035) 0 2px, rgba(0,0,0,0) 2px 10px),
      repeating-linear-gradient(-45deg, rgba(255,255,255,.02) 0 2px, rgba(0,0,0,0) 2px 12px);
    opacity:.35;
    pointer-events:none;
  }

  .app{
    width:100vw;
    height:100svh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 3vh 4vw;
  }

  .board{
    width:100%;
    height:100%;
    max-width:1700px;
    max-height:930px;
    border-radius:22px;
    background: linear-gradient(180deg, rgba(10,10,10,.70), rgba(0,0,0,.55));
    border: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 0 70px rgba(225,6,0,.28);
    overflow:hidden;
    position:relative;
    backdrop-filter: blur(6px);
  }

  .board::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      linear-gradient(115deg, transparent 0 62%, rgba(225,6,0,.18) 62% 66%, transparent 66% 100%),
      linear-gradient(115deg, transparent 0 74%, rgba(225,6,0,.10) 74% 76%, transparent 76% 100%);
    pointer-events:none;
  }

  .header{
    padding: 22px 26px 14px;
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:16px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    position:relative;
    z-index:1;
  }

  .title{
    display:flex;
    align-items:baseline;
    gap:14px;
  }

  .f1mark{
    font-family: Teko, Rajdhani, sans-serif;
    font-weight:700;
    font-size: clamp(28px, 3.2vw, 54px);
    letter-spacing:.08em;
    text-transform: uppercase;
    line-height:1;
  }
  .f1mark .red{ color: var(--f1-red); }

  .subtitle{
    font-weight:700;
    letter-spacing:.18em;
    text-transform: uppercase;
    font-size: clamp(14px, 1.4vw, 20px);
    color: var(--muted);
    transform: translateY(-3px);
    white-space:nowrap;
  }

  .status{
    font-weight:700;
    letter-spacing:.12em;
    text-transform: uppercase;
    font-size: clamp(12px, 1.2vw, 16px);
    color: var(--muted);
    white-space:nowrap;
  }

  .content{
    height: calc(100% - 86px);
    padding: 22px 26px 26px;
    display:flex;
    flex-direction:column;
    gap: 18px;
    position:relative;
    z-index:1;
  }

  .checkline{
    height: 10px;
    border-radius: 999px;
    background:
      linear-gradient(90deg, rgba(225,6,0,.75), rgba(225,6,0,0)),
      repeating-linear-gradient(90deg, rgba(255,255,255,.14) 0 10px, rgba(0,0,0,0) 10px 20px);
    opacity:.75;
    border: 1px solid rgba(255,255,255,.08);
  }

  .rows{
    flex:1;
    display:flex;
    flex-direction:column;
    justify-content:center;
    gap: 18px;
    position:relative;
  }

  .row{
    height: clamp(92px, 14vh, 150px);
    display:grid;
    grid-template-columns: 12% 1fr 22%;
    align-items:center;
    gap: 18px;
    padding: 14px 16px;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(10,10,10,.55);
    position:relative;
    overflow:hidden;
    will-change: transform;
  }

  .row::after{
    content:"";
    position:absolute;
    inset:0;
    background: linear-gradient(115deg, transparent 0 58%, rgba(255,255,255,.06) 58% 60%, transparent 60% 100%);
    pointer-events:none;
  }

  .row::before{
    content:"";
    position:absolute;
    inset:-90px -220px;
    background: radial-gradient(circle at 30% 50%, rgba(255,255,255,.22), transparent 60%);
    animation: sweep 4.2s ease-in-out infinite;
    opacity:.75;
    pointer-events:none;
  }
  @keyframes sweep{
    0%{ transform: translateX(-45%) rotate(6deg); }
    50%{ transform: translateX(8%) rotate(6deg); }
    100%{ transform: translateX(-45%) rotate(6deg); }
  }

  .pos{
    height: 100%;
    border-radius: 14px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family: Teko, Rajdhani, sans-serif;
    font-weight:700;
    font-size: clamp(40px, 5vw, 76px);
    letter-spacing:.04em;
    color: rgba(0,0,0,.9);
    box-shadow: inset 0 0 18px rgba(255,255,255,.18);
    user-select:none;
  }

  .pilot{
    display:flex;
    flex-direction:column;
    gap: 6px;
    min-width:0;
  }
  .pilot .name{
    font-weight:700;
    font-size: clamp(24px, 3.2vw, 52px);
    line-height: 1.0;
    text-transform: uppercase;
    letter-spacing: .06em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .pilot .meta{
    display:flex;
    gap: 10px;
    align-items:center;
    color: var(--muted);
    font-weight:700;
    letter-spacing: .14em;
    text-transform: uppercase;
    font-size: clamp(12px, 1.25vw, 16px);
  }
  .pilot .meta .bar{
    width: 44px;
    height: 3px;
    border-radius: 99px;
    background: rgba(255,255,255,.20);
  }

  .pts{
    height: 100%;
    border-radius: 14px;
    padding: 12px 14px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:flex-end;
    color: rgba(0,0,0,.92);
    box-shadow: inset 0 0 18px rgba(255,255,255,.18);
  }
  .pts .label{
    font-weight:800;
    letter-spacing: .22em;
    text-transform: uppercase;
    font-size: clamp(12px, 1.2vw, 16px);
    opacity:.85;
  }
  .pts .val{
    font-family: Teko, Rajdhani, sans-serif;
    font-weight:700;
    font-size: clamp(34px, 4.2vw, 76px);
    line-height: .9;
    letter-spacing: .06em;
  }

  .gold{ border-color: rgba(255,215,0,.22); }
  .gold .pos, .gold .pts{ background: linear-gradient(90deg, var(--gold1), var(--gold2)); }

  .silver{ border-color: rgba(192,192,192,.22); }
  .silver .pos, .silver .pts{ background: linear-gradient(90deg, var(--silver1), var(--silver2)); }

  .bronze{ border-color: rgba(205,127,50,.22); }
  .bronze .pos, .bronze .pts{ background: linear-gradient(90deg, var(--bronze1), var(--bronze2)); }

  .bump{ animation: bump .38s ease; }
  @keyframes bump{
    0%{ transform: scale(1); }
    45%{ transform: scale(1.06); }
    100%{ transform: scale(1); }
  }

  .flip{
    transition: transform 520ms cubic-bezier(.2,.9,.2,1);
  }

  .fade-in{ animation: fadeIn .28s ease; }
  @keyframes fadeIn{
    from{ opacity:0; transform: translateY(12px); }
    to{ opacity:1; transform: translateY(0); }
  }
</style>
</head>

<body>
<div class="app">
  <div class="board">
    <div class="header">
      <div class="title">
        <div class="f1mark"><span class="red">Forza</span> LEADERBOARD</div>
        <div class="subtitle">Зачет</div>
      </div>
      <div class="status" id="status">Подключение…</div>
    </div>

    <div class="content">
      <div class="checkline"></div>
      <div class="rows" id="rows"></div>
    </div>
  </div>
</div>

<script>
  // ====== ТВОЙ GOOGLE SHEETS (опубликованный) ======
  const PUB_ID  = "2PACX-1vQvwffbzZpdoLI4y1BoWfRvpeE7l4UYSyIoSj9o27T8N7X-7JqI20EYPCv4hUmaZiP81ST1mhkAPiIp";
  const GID     = "748230739";
  const POLL_MS = 5000;
  // ================================================
  const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${PUB_ID}/pub?output=csv&gid=${GID}&single=true`;

  const rowsEl   = document.getElementById("rows");
  const statusEl = document.getElementById("status");

  // чтобы не "дёргалось" — обновляем DOM только если реально есть изменения
  let lastState = null;

  function sameState(a, b){
    if (!a || !b || a.length !== b.length) return false;
    for (let i = 0; i < a.length; i++){
      if (a[i].name !== b[i].name || a[i].points !== b[i].points || a[i].pos !== b[i].pos) return false;
    }
    return true;
  }

  // FLIP: снимок позиций элементов ДО перестановки
  function snapshotRects() {
    const m = new Map();
    [...rowsEl.children].forEach(el => {
      m.set(el.dataset.key, el.getBoundingClientRect());
    });
    return m;
  }

  // FLIP: проигрываем анимацию после перестановки DOM
  function playFLIP(beforeRects) {
    [...rowsEl.children].forEach(el => {
      const key = el.dataset.key;
      const after = el.getBoundingClientRect();
      const before = beforeRects.get(key);
      if (!before) return;

      const dx = before.left - after.left;
      const dy = before.top  - after.top;

      if (dx || dy) {
        el.classList.remove("flip");
        el.style.transform = `translate(${dx}px, ${dy}px)`;
        void el.offsetWidth;
        el.classList.add("flip");
        el.style.transform = "";
      }
    });
  }

  // CSV парсер (кавычки/запятые)
  function parseCSV(text){
    const rows = [];
    let cur = [], cell = "", inQuotes = false;

    for (let i=0; i<text.length; i++){
      const ch = text[i];
      const next = text[i+1];

      if (ch === '"'){
        if (inQuotes && next === '"'){ cell += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === ',' && !inQuotes){
        cur.push(cell); cell = "";
      } else if ((ch === '\n' || ch === '\r') && !inQuotes){
        if (ch === '\r' && next === '\n') i++;
        cur.push(cell); rows.push(cur);
        cur = []; cell = "";
      } else {
        cell += ch;
      }
    }
    if (cell.length || cur.length){ cur.push(cell); rows.push(cur); }
    return rows;
  }

  function norm(s){ return (s || "").trim().toLowerCase(); }

  // Берём все строки, сортируем по очкам, берём топ-3
  function extractSortedTop3(csvMatrix){
    if (!csvMatrix.length) return [];
    const header = csvMatrix[0].map(norm);

    const idxName   = header.indexOf("пилот");
    const idxPoints = header.indexOf("очки");

    if (idxName === -1 || idxPoints === -1) {
      throw new Error("Не найдены столбцы: Пилот / Очки");
    }

    const all = csvMatrix.slice(1)
      .filter(r => r && r.length)
      .map(r => ({
        name: String((r[idxName] ?? "")).trim(),
        points: Number(String((r[idxPoints] ?? "")).trim().replace(",", ".")) || 0
      }))
      .filter(r => r.name.length > 0);

    all.sort((a,b) => b.points - a.points);
    return all.slice(0,3).map((r, i) => ({ pos: i+1, ...r }));
  }

  function themeByPos(pos){
    return pos === 1 ? "gold" : (pos === 2 ? "silver" : "bronze");
  }

  function makeRow(item){
    const el = document.createElement("div");
    el.className = `row ${themeByPos(item.pos)} fade-in`;
    el.dataset.key = item.name; // ключ для перестановки (имя должно быть уникальным)

    el.innerHTML = `
      <div class="pos">${item.pos}</div>
      <div class="pilot">
        <div class="name"></div>
        <div class="meta"><span class="bar"></span><span>Points</span></div>
      </div>
      <div class="pts">
        <div class="label">Очки</div>
        <div class="val"></div>
      </div>
    `;
    el.querySelector(".pilot .name").textContent = item.name || "—";
    el.querySelector(".pts .val").textContent = item.points ?? 0;
    return el;
  }

  function bumpPoints(el){
    const box = el.querySelector(".pts");
    box.classList.remove("bump");
    void box.offsetWidth;
    box.classList.add("bump");
  }

  // Перерисовка/перестановка с FLIP-анимацией
  function renderWithReorder(nextTop3){
    const before = snapshotRects();
    const existing = new Map([...rowsEl.children].map(el => [el.dataset.key, el]));

    const frag = document.createDocumentFragment();

    nextTop3.forEach(item => {
      let el = existing.get(item.name);

      if (!el) {
        el = makeRow(item);
      } else {
        el.querySelector(".pos").textContent = item.pos;
        el.classList.remove("gold","silver","bronze");
        el.classList.add(themeByPos(item.pos));

        const valEl = el.querySelector(".pts .val");
        const oldPts = Number(valEl.textContent) || 0;
        if (oldPts !== item.points) {
          valEl.textContent = item.points;
          bumpPoints(el);
        }
      }

      frag.appendChild(el);
    });

    rowsEl.innerHTML = "";
    rowsEl.appendChild(frag);

    playFLIP(before);
  }

  async function tick(){
    try{
      statusEl.textContent = "Online";

      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();

      const matrix = parseCSV(text.trim());
      const top3 = extractSortedTop3(matrix);

      while (top3.length < 3) top3.push({ pos: top3.length+1, name: "—", points: 0 });

      // ✅ если ничего не изменилось — НЕ трогаем DOM, поэтому нет дёрганий
      if (sameState(lastState, top3)) return;
      lastState = JSON.parse(JSON.stringify(top3));

      renderWithReorder(top3);

    } catch (e){
      statusEl.textContent = "Error";
      console.error(e);
    }
  }

  tick();
  setInterval(tick, POLL_MS);
</script>
</body>
</html>
